<!-- report.html -->
<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Report Details</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
  <header class="flex justify-between items-center h-16 border-b border-gray-700 px-6">
    <div class="flex items-center gap-2">
      <span class="inline-block w-3 h-3 rounded-sm bg-indigo-500"></span>
      <h1 class="text-xl font-bold">CivicLens</h1>
      <span class="ml-4 text-sm text-gray-400">Reports / Report Details</span>
      <nav class="hidden md:flex items-center gap-2 ml-6 text-sm text-gray-400">
        <a href="leaderboard.html" class="px-2 py-1 hover:text-gray-200">Leaderboard</a>
      </nav>
    </div>
    <a id="backLink" href="dashboard.html" class="text-sm text-gray-300 hover:text-blue-400">‚Üê Back to Dashboard</a>
  </header>

  <main class="p-6 max-w-6xl mx-auto">
    <h2 id="reportTitle" class="text-2xl font-bold mb-4">Report</h2>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
      <div class="lg:col-span-2 space-y-4">
        <img id="photo" alt="Report image" class="w-full h-[280px] object-cover rounded-lg border border-gray-700"/>
        <iframe id="map" class="w-full h-[220px] rounded-lg border border-gray-700" loading="lazy" title="Location"></iframe>
      </div>
      <div class="space-y-4">
        <div class="bg-gray-800 rounded-lg p-5 border border-gray-700">
          <h3 class="font-bold text-lg">Citizen Report</h3>
          <p id="citizenReport" class="mt-2 text-gray-300"></p>
        </div>
        <div class="bg-gray-800 rounded-lg p-5 border border-gray-700">
          <h3 class="font-bold text-lg">AI Analysis</h3>
          <div class="mt-2 text-sm divide-y divide-gray-700">
            <div class="flex justify-between py-2"><span class="text-gray-400">Category</span><span id="aiCategory"></span></div>
            <div class="flex justify-between py-2"><span class="text-gray-400">Severity</span><span id="aiSeverity"></span></div>
            <div class="flex justify-between py-2"><span class="text-gray-400">Urgency</span><span id="aiUrgency"></span></div>
            <div class="flex justify-between py-2"><span class="text-gray-400">Summary</span><span id="aiSummary" class="text-right"></span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 bg-gray-800 rounded-lg p-5 border border-gray-700">
      <h3 class="font-bold text-lg mb-4">Actions</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Status of the Report</label>
          <div class="flex items-center gap-3">
            <select id="statusSelect" class="bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-sm">
              <option value="RECEIVED">Received</option>
              <option value="UNDER_REVIEW">Under Review</option>
              <option value="ASSIGNED">Assigned</option>
              <option value="IN_PROGRESS">In Progress</option>
              <option value="RESOLVED">Resolved (Awaiting Confirmation)</option>
              <option value="CONFIRMED_CLOSED">Verified</option>
              <option value="REOPENED">Reopened</option>
            </select>
            <span id="saveStatusMsg" class="text-xs text-gray-400"></span>
          </div>
        </div>
        <div class="flex items-end gap-3">
          <button id="setStatusBtn" class="px-4 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-700">Set Status</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Check for department authentication
    const deptAuth = localStorage.getItem('DEPT_AUTH');
    if (!deptAuth) {
      window.location.href = 'index.html';
    }

    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('id');
    const deptParam = urlParams.get('dept') || '';
    if(deptParam){
      const back = document.getElementById('backLink');
      back.href = `dashboard.html?dept=${encodeURIComponent(deptParam)}`;
    }

    function imageFor(category, summary){
      const s = ((category||'') + ' ' + (summary||'')).toLowerCase();
      if(s.includes('pothole') || s.includes('road')) return 'https://source.unsplash.com/featured/800x500/?pothole,road,maintenance';
      if(s.includes('water') || s.includes('pipe') || s.includes('flood')) return 'https://source.unsplash.com/featured/800x500/?water,pipe,leak,street';
      if(s.includes('traffic') || s.includes('signal')) return 'https://source.unsplash.com/featured/800x500/?traffic,signal,city';
      if(s.includes('light') || s.includes('streetlight')) return 'https://source.unsplash.com/featured/800x500/?streetlight,night,city';
      if(s.includes('park') || s.includes('tree')) return 'https://source.unsplash.com/featured/800x500/?city,park,maintenance';
      if(s.includes('graffiti')) return 'https://source.unsplash.com/featured/800x500/?graffiti,wall,city';
      if(s.includes('trash') || s.includes('garbage') || s.includes('waste')) return 'https://source.unsplash.com/featured/800x500/?garbage,trash,city';
      if(s.includes('safety') || s.includes('crime')) return 'https://source.unsplash.com/featured/800x500/?public,safety,police,city';
      return 'https://source.unsplash.com/featured/800x500/?city,infrastructure';
    }

    async function fetchReport(){
      // Try backend detail first
      try{
        const res = await fetch(`/reports/${encodeURIComponent(reportId)}`);
        if(!res.ok) throw new Error('api');
        return await res.json();
      }catch{
        // Fallback to seed list and find
        const local = JSON.parse(localStorage.getItem('DEMO_REPORTS')||'null');
        const list = Array.isArray(local) ? local : (await (await fetch('seed/sample_reports.json')).json());
        return list.find(r => r.id === reportId);
      }
    }

    function setMap(lat, lon){
      if(lat==null || lon==null){ document.getElementById('map').style.display='none'; return; }
      const bbox = `${lon-0.005}%2C${lat-0.005}%2C${lon+0.005}%2C${lat+0.005}`;
      const url = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat}%2C${lon}`;
      document.getElementById('map').src = url;
    }

    async function updateStatus(id, newStatus){
      try{
        const res = await fetch(`/reports/${encodeURIComponent(id)}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            // Demo admin token for backend stub
            'Authorization': 'Bearer changeme'
          },
          body: JSON.stringify({ status: newStatus })
        });
        if(!res.ok) throw new Error('Failed');
        const data = await res.json();
        // Clear any local override if backend accepted
        const overrides = JSON.parse(localStorage.getItem('REPORT_STATUS_OVERRIDES')||'{}');
        delete overrides[id];
        localStorage.setItem('REPORT_STATUS_OVERRIDES', JSON.stringify(overrides));
        return data;
      }catch(e){
        // Fallback: optimistic local update only and persist in localStorage
        const overrides = JSON.parse(localStorage.getItem('REPORT_STATUS_OVERRIDES')||'{}');
        overrides[id] = newStatus;
        localStorage.setItem('REPORT_STATUS_OVERRIDES', JSON.stringify(overrides));
        return null;
      }
    }

    (async function init(){
      const r = await fetchReport();
      if(!r){ document.getElementById('reportTitle').innerText = 'Report Not Found'; return; }
      document.getElementById('reportTitle').innerText = `Report #${r.id.slice(0,5)}`;
      document.getElementById('citizenReport').innerText = r.description || 'No description provided.';
      document.getElementById('aiCategory').innerText = r.ai_category || '-';
      document.getElementById('aiSeverity').innerText = r.ai_severity_score!=null? r.ai_severity_score.toFixed(1) : '-';
      document.getElementById('aiUrgency').innerText = r.ai_urgency_level || '-';
      document.getElementById('aiSummary').innerText = r.ai_summary || '-';

      const img = r.photo_url || imageFor(r.ai_category, r.ai_summary);
      document.getElementById('photo').src = img;

      setMap(r.latitude, r.longitude);

      // Status selector
      const statusSelect = document.getElementById('statusSelect');
      if(statusSelect){
        const overrides = JSON.parse(localStorage.getItem('REPORT_STATUS_OVERRIDES')||'{}');
        const effectiveStatus = overrides[r.id] || r.status || 'RECEIVED';
        statusSelect.value = effectiveStatus;
        const msg = document.getElementById('saveStatusMsg');
        const setBtn = document.getElementById('setStatusBtn');
        setBtn.addEventListener('click', async () => {
          const value = statusSelect.value;
          msg.textContent = 'Saving...';
          await updateStatus(r.id, value);
          msg.textContent = 'Saved';
          setTimeout(()=> msg.textContent='', 1500);
        });
      }

      // Removed acknowledge/resolve quick buttons in favor of Set Status
    })();
  </script>
</body>
</html>
