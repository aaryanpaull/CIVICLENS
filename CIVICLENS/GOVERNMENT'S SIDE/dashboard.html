<!-- dashboard.html -->
<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CivicLens Dashboard</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
  <header class="flex justify-between items-center h-16 border-b border-gray-700 px-6">
    <div class="flex items-center gap-2">
      <span class="inline-block w-3 h-3 rounded-sm bg-indigo-500"></span>
      <h1 class="text-xl font-bold">CivicLens</h1>
      <nav class="hidden md:flex items-center gap-2 ml-6 text-sm text-gray-400">
        <span class="px-2 py-1 rounded bg-gray-800 text-gray-200">Dashboard</span>
        <a href="leaderboard.html" class="px-2 py-1 hover:text-gray-200">Leaderboard</a>
        <a href="stats.html" class="px-2 py-1 hover:text-gray-200">Statistics</a>
      </nav>
    </div>
    <div class="flex items-center gap-3">
      <div class="hidden sm:block">
        <input id="q" placeholder="Search reports..." class="bg-gray-800/80 border border-gray-700 rounded-md px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 w-64"/>
      </div>
      <button id="logoutBtn" class="text-sm text-gray-300 hover:text-red-400">Logout</button>
    </div>
  </header>

  <main class="p-6">
    <h2 class="text-2xl font-bold mb-1" id="dashTitle">Dashboard</h2>
    <p class="text-sm text-gray-400 mb-4" id="dashSub">Manage and respond to citizen reports.</p>

    <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between mb-3">
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-400">Department</label>
        <select id="deptSelect" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
          <option value="">All</option>
        </select>
        <label class="text-sm text-gray-400 ml-4">Sort by</label>
        <select id="sortSelect" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
          <option value="severity-desc">Severity (High to Low)</option>
          <option value="severity-asc">Severity (Low to High)</option>
          <option value="urgency-desc">Urgency (Critical to Low)</option>
          <option value="urgency-asc">Urgency (Low to Critical)</option>
          <option value="date-desc">Date (Newest First)</option>
          <option value="date-asc">Date (Oldest First)</option>
        </select>
      </div>
      <div id="deptEmail" class="text-xs text-gray-400"></div>
    </div>
    <div class="overflow-x-auto rounded-lg border border-gray-700">
      <table class="min-w-full divide-y divide-gray-700" aria-label="Reports table">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-400">Urgency</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-400">Severity</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-400">AI Summary</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-400">Category</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-400">Location</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-400">Date Reported</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-400">Status</th>
          </tr>
        </thead>
        <tbody id="reportsTbody" class="divide-y divide-gray-700"></tbody>
      </table>
    </div>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // Check for department authentication
    const deptAuth = localStorage.getItem('DEPT_AUTH');
    
    if (!deptAuth) {
      // Redirect to main index page if no department authentication
      window.location.href = 'index.html';
    }
    
    // Parse department authentication if available
    let currentDepartment = null;
    if (deptAuth) {
      try {
        const authData = JSON.parse(deptAuth);
        currentDepartment = authData.department;
      } catch (e) {
        console.error('Invalid department auth data:', e);
        localStorage.removeItem('DEPT_AUTH');
        window.location.href = 'index.html';
      }
    }

    // Department mapping and helpers
    const DEPARTMENTS = {
      'Roads': { email: 'roads.dept@gccdemo.in' },
      'Waste Management': { email: 'waste@gccdemo.in' },
      'Infrastructure': { email: 'infrastructure@gccdemo.in' },
      'Street Lighting': { email: 'streetlighting@gccdemo.in' },
      'Water and Sewage': { email: 'water.sewage@gccdemo.in' },
      'Political Issues / Vandalism': { email: 'enforcement@gccdemo.in' },
      'Public Health & Sanitation': { email: 'publichealth@gccdemo.in' },
      'Parks & Green Spaces': { email: 'parks@gccdemo.in' },
      'Encroachments & Illegal Constructions': { email: 'planning@gccdemo.in' },
      'Noise & Air Pollution': { email: 'pollution@gccdemo.in' },
      'Flooding & Drainage': { email: 'drainage@gccdemo.in' },
      'Traffic & Parking Issues': { email: 'traffic@gccdemo.in' },
      'Electricity & Power Supply': { email: 'electricity@gccdemo.in' },
      'Public Transport & Bus Stops': { email: 'transport@gccdemo.in' },
      'Drinking Water Quality': { email: 'drinkingwater@gccdemo.in' }
    };
    const DEPT_NAMES = Object.keys(DEPARTMENTS);
    function normalize(s){ return String(s||'').toLowerCase(); }
    function departmentFor(category){
      const c = normalize(category);
      for(const name of DEPT_NAMES){
        // match whole name or any token segment present in category text
        const n = normalize(name);
        if(c === n || c.includes(n) || n.includes(c)) return name;
        // handle common aliases
        if(c.includes('road')) return 'Roads';
        if(c.includes('waste') || c.includes('garbage') || c.includes('trash')) return 'Waste Management';
        if(c.includes('infra')) return 'Infrastructure';
        if(c.includes('light')) return 'Street Lighting';
        if(c.includes('water') && c.includes('sew')) return 'Water and Sewage';
        if(c.includes('vandal') || c.includes('politic')) return 'Political Issues / Vandalism';
        if(c.includes('health') || c.includes('sanitation')) return 'Public Health & Sanitation';
        if(c.includes('park') || c.includes('green')) return 'Parks & Green Spaces';
        if(c.includes('encroach') || c.includes('illegal') || c.includes('construction')) return 'Encroachments & Illegal Constructions';
        if(c.includes('noise') || c.includes('air')) return 'Noise & Air Pollution';
        if(c.includes('flood') || c.includes('drain')) return 'Flooding & Drainage';
        if(c.includes('traffic') || c.includes('parking')) return 'Traffic & Parking Issues';
        if(c.includes('electric')) return 'Electricity & Power Supply';
        if(c.includes('transport') || c.includes('bus')) return 'Public Transport & Bus Stops';
        if(c.includes('drinking') && c.includes('water')) return 'Drinking Water Quality';
      }
      return null;
    }

    function urgencyBadge(level){
      const map = {
        CRITICAL: 'bg-red-900/40 text-red-300 border-red-800',
        HIGH: 'bg-yellow-900/30 text-yellow-300 border-yellow-800',
        MEDIUM: 'bg-amber-900/20 text-amber-300 border-amber-800',
        LOW: 'bg-emerald-900/20 text-emerald-300 border-emerald-800'
      };
      const cls = map[level] || 'bg-gray-800 text-gray-300 border-gray-700';
      return `<span class="text-xs px-2 py-1 border rounded-full ${cls}">${level||'-'}</span>`;
    }
    function statusPill(st){
      const map = {
        RECEIVED: 'bg-gray-800 text-gray-300 border-gray-700',
        UNDER_REVIEW: 'bg-slate-900/40 text-slate-300 border-slate-800',
        ASSIGNED: 'bg-blue-900/30 text-blue-300 border-blue-800',
        IN_PROGRESS: 'bg-indigo-900/30 text-indigo-300 border-indigo-800',
        RESOLVED: 'bg-emerald-900/30 text-emerald-300 border-emerald-800',
        CONFIRMED_CLOSED: 'bg-slate-800 text-slate-300 border-slate-700',
        REOPENED: 'bg-amber-900/30 text-amber-300 border-amber-800'
      };
      const cls = map[st] || 'bg-gray-800 text-gray-300 border-gray-700';
      const label = ({RECEIVED:'Received',UNDER_REVIEW:'Under Review',ASSIGNED:'Assigned',IN_PROGRESS:'In Progress',RESOLVED:'Resolved',CONFIRMED_CLOSED:'Verified',REOPENED:'Reopened'})[st]||st;
      return `<span class="text-xs px-2 py-1 border rounded-full ${cls}">${label}</span>`;
    }
    function fmtDate(iso){ try{ return new Date(iso).toLocaleDateString(); }catch{ return iso; } }

    // Chennai demo locations
    const CHENNAI_SPOTS = [
      {name:'Marina Beach', lat:13.0500, lon:80.2824},
      {name:'T Nagar', lat:13.0418, lon:80.2337},
      {name:'Anna Nagar', lat:13.0839, lon:80.2060},
      {name:'Adyar', lat:13.0067, lon:80.2570},
      {name:'Velachery', lat:12.9791, lon:80.2212},
      {name:'Sholinganallur', lat:12.8978, lon:80.2249},
      {name:'Tambaram', lat:12.9246, lon:80.1278},
      {name:'Perambur', lat:13.1215, lon:80.2305},
      {name:'Guindy', lat:13.0107, lon:80.2120},
      {name:'Mylapore', lat:13.0333, lon:80.2700},
      {name:'Chromepet', lat:12.9516, lon:80.1450},
      {name:'Porur', lat:13.0378, lon:80.1588},
      {name:'Madipakkam', lat:12.9670, lon:80.2000},
      {name:'Pallavaram', lat:12.9676, lon:80.1500},
      {name:'Alandur', lat:13.0213, lon:80.2056},
      {name:'Royapuram', lat:13.1106, lon:80.2943},
      {name:'Kilpauk', lat:13.0805, lon:80.2350},
      {name:'Triplicane', lat:13.0555, lon:80.2796},
      {name:'Saidapet', lat:13.0240, lon:80.2240},
      {name:'Ambattur', lat:13.1143, lon:80.1483}
    ];

    function randomOf(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)}); }
    function randomUrgency(){ return randomOf(['LOW','MEDIUM','HIGH','CRITICAL']); }
    
    // Sorting function for reports
    function sortReports(reports, sortBy) {
      const urgencyOrder = { 'CRITICAL': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
      
      return [...reports].sort((a, b) => {
        switch(sortBy) {
          case 'severity-desc':
            return (b.ai_severity_score || 0) - (a.ai_severity_score || 0);
          case 'severity-asc':
            return (a.ai_severity_score || 0) - (b.ai_severity_score || 0);
          case 'urgency-desc':
            return (urgencyOrder[b.ai_urgency_level] || 0) - (urgencyOrder[a.ai_urgency_level] || 0);
          case 'urgency-asc':
            return (urgencyOrder[a.ai_urgency_level] || 0) - (urgencyOrder[b.ai_urgency_level] || 0);
          case 'date-desc':
            return new Date(b.created_at) - new Date(a.created_at);
          case 'date-asc':
            return new Date(a.created_at) - new Date(b.created_at);
          default:
            return 0;
        }
      });
    }
    function randomStatus(){ return randomOf(['RECEIVED','UNDER_REVIEW','ASSIGNED','IN_PROGRESS','RESOLVED']); }
    function descriptionFor(dept){
      const map = {
        'Roads': 'Pothole reported causing traffic slowdowns.',
        'Waste Management': 'Overflowing garbage bin requires cleanup.',
        'Infrastructure': 'Broken sidewalk tiles creating tripping hazard.',
        'Street Lighting': 'Streetlight not working; area dark at night.',
        'Water and Sewage': 'Leaking water pipe near junction.',
        'Political Issues / Vandalism': 'Graffiti on public wall needs removal.',
        'Public Health & Sanitation': 'Unsanitary area reported by residents.',
        'Parks & Green Spaces': 'Damaged park bench and fallen branches.',
        'Encroachments & Illegal Constructions': 'Illegal encroachment narrowing road.',
        'Noise & Air Pollution': 'Loud generator operating at night.',
        'Flooding & Drainage': 'Waterlogging after rain due to blocked drain.',
        'Traffic & Parking Issues': 'Illegal parking blocking bus stop.',
        'Electricity & Power Supply': 'Frequent outages reported.',
        'Public Transport & Bus Stops': 'Damaged bus shelter roof.',
        'Drinking Water Quality': 'Tap water discoloration observed.'
      };
      return map[dept] || 'Issue reported by citizens.';
    }

    function ensureMinPerDept(list, minEach){
      const now = Date.now();
      const byDept = {};
      for(const r of list){
        const d = departmentFor(r.ai_category) || 'Unassigned';
        if(!byDept[d]) byDept[d] = [];
        byDept[d].push(r);
      }
      for(const dept of DEPT_NAMES){
        const arr = byDept[dept] || [];
        const need = Math.max(0, minEach - arr.length);
        for(let i=0;i<need;i++){
          const spot = randomOf(CHENNAI_SPOTS);
          const id = uuid();
          const status = randomStatus();
          const created = new Date(now - Math.floor(Math.random()*14)*86400000).toISOString();
          arr.push({
            id,
            user_id: uuid(),
            photo_url: '',
            latitude: spot.lat,
            longitude: spot.lon,
            locality: spot.name,
            description: descriptionFor(dept),
            ai_category: dept,
            ai_summary: descriptionFor(dept),
            ai_severity_score: Number((Math.random()*4+1).toFixed(1)),
            ai_urgency_level: randomUrgency(),
            status,
            created_at: created,
            updated_at: created,
            resolved_by: null,
            resolved_at: null,
            reopen_count: 0
          });
        }
        byDept[dept] = arr;
      }
      // Flatten
      return Object.values(byDept).flat();
    }

    async function fetchReports(){
      try{
        let url = '/reports';
        let headers = {};
        
        // If authenticated as department, use department-specific endpoint
        if (currentDepartment) {
          const authData = JSON.parse(localStorage.getItem('DEPT_AUTH'));
          url = '/reports/department';
          headers['Authorization'] = `Bearer ${authData.token}`;
        }
        
        const res = await fetch(url, { headers });
        if(!res.ok) throw new Error('api');
        return await res.json();
      }catch{
        const res = await fetch('seed/sample_reports.json');
        return await res.json();
      }
    }

    function render(list){
      // Merge any local status overrides (when backend not used)
      const overrides = JSON.parse(localStorage.getItem('REPORT_STATUS_OVERRIDES')||'{}');
      const q = ($('#q')?.value||'').trim().toLowerCase();
      const dept = ($('#deptSelect')?.value||'');
      const sortBy = ($('#sortSelect')?.value||'severity-desc');
      let filtered = list;
      if(q){ filtered = filtered.filter(r => (r.ai_summary||'').toLowerCase().includes(q) || (r.ai_category||'').toLowerCase().includes(q)); }
      if(dept){ filtered = filtered.filter(r => departmentFor(r.ai_category) === dept); }
      
      // Apply sorting
      filtered = sortReports(filtered, sortBy);
      const tbody = document.getElementById('reportsTbody');
      tbody.innerHTML = '';
      for(const r of filtered){
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-800/60 cursor-pointer';
        tr.onclick = () => viewReport(r.id);
        const status = overrides[r.id] || r.status;
        tr.innerHTML = `
          <td class="px-6 py-3">${urgencyBadge(r.ai_urgency_level)}</td>
          <td class="px-6 py-3">${r.ai_severity_score!=null? r.ai_severity_score.toFixed(1):'-'}</td>
          <td class="px-6 py-3">${r.ai_summary? r.ai_summary: '-'}</td>
          <td class="px-6 py-3">${r.ai_category||'-'}</td>
          <td class="px-6 py-3">
            ${r.locality? `<button class=\"text-blue-300 hover:underline\" data-lat=\"${r.latitude}\" data-lon=\"${r.longitude}\" data-name=\"${r.locality}\" onclick=\"showMap(event)\">${r.locality}</button>` : '-'}
          </td>
          <td class="px-6 py-3">${fmtDate(r.created_at)}</td>
          <td class="px-6 py-3">${statusPill(status)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function viewReport(id){
      const dept = ($('#deptSelect')?.value||'');
      const param = dept? `&dept=${encodeURIComponent(dept)}` : '';
      window.location.href = `report.html?id=${encodeURIComponent(id)}${param}`;
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('DEPT_AUTH');
      window.location.href = 'index.html';
    });

    // Lightweight OSM modal using iframe
    window.showMap = (e) => {
      e.stopPropagation();
      const btn = e.currentTarget;
      const lat = parseFloat(btn.getAttribute('data-lat'));
      const lon = parseFloat(btn.getAttribute('data-lon'));
      const name = btn.getAttribute('data-name') || 'Location';
      const bbox = `${lon-0.01}%2C${lat-0.01}%2C${lon+0.01}%2C${lat+0.01}`;
      const url = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat}%2C${lon}`;
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4';
      overlay.innerHTML = `
        <div class=\"bg-gray-900 border border-gray-700 rounded-lg w-full max-w-3xl\">
          <div class=\"flex items-center justify-between p-3 border-b border-gray-700\">
            <div class=\"font-semibold\">${name}</div>
            <button class=\"text-gray-300 hover:text-white\" onclick=\"this.closest('div.fixed').remove()\">✕</button>
          </div>
          <iframe src=\"${url}\" class=\"w-full h-[420px]\" loading=\"lazy\" title=\"Map\"></iframe>
        </div>`;
      document.body.appendChild(overlay);
    };

    (async function init(){
      // populate department dropdown
      const sel = document.getElementById('deptSelect');
      for(const name of DEPT_NAMES){
        const opt = document.createElement('option'); opt.value = name; opt.textContent = name; sel.appendChild(opt);
      }
      
      // Apply department from authentication or query param
      const params = new URLSearchParams(window.location.search);
      const deptFromUrl = params.get('dept') || '';
      let selectedDept = '';
      
      if (currentDepartment) {
        // If authenticated as department, lock to that department
        selectedDept = currentDepartment.name;
        sel.value = selectedDept;
        sel.disabled = true; // Disable dropdown for department users
      } else if (deptFromUrl && DEPARTMENTS[deptFromUrl]) {
        selectedDept = deptFromUrl;
        sel.value = selectedDept;
      }

      function updateHeader(){
        const d = sel.value;
        if(d){
          document.getElementById('dashTitle').textContent = `${d} — Dashboard`;
          const email = DEPARTMENTS[d]?.email || '';
          document.getElementById('dashSub').textContent = currentDepartment ? 
            `Welcome, ${currentDepartment.displayName}. Manage your department's reports.` :
            'Reports routed for this department.';
          document.getElementById('deptEmail').textContent = email? `Contact: ${email}` : '';
        }else{
          document.getElementById('dashTitle').textContent = 'Dashboard';
          document.getElementById('dashSub').textContent = 'Manage and respond to citizen reports.';
          document.getElementById('deptEmail').textContent = '';
        }
      }

      const raw = await fetchReports();
      const expanded = ensureMinPerDept(raw, 4);
      localStorage.setItem('DEMO_REPORTS', JSON.stringify(expanded));
      render(expanded);
      const search = document.getElementById('q');
      const sortSelect = document.getElementById('sortSelect');
      if(search){ search.addEventListener('input', () => render(expanded)); }
      if(sortSelect){ sortSelect.addEventListener('change', () => render(expanded)); }
      sel.addEventListener('change', () => { updateHeader(); render(expanded); });
      updateHeader();
    })();
  </script>
</body>
</html>
